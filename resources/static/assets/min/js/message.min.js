function listen_message(){$.ajax({type:"GET",url:"/site/listen-message.html",data:{},dataType:"json",success:function(e){1==e.code?(playSound(2),listen_message()):2==e.code&&listen_message()}})}function playSound(e,t){var o=e.type,n=null!=e.notice_count?e.notice_count:1,s=e.notice_interval?e.notice_interval:1e3;if(null==t&&(t=n),0!=t)if(0==$("#sound").size()&&$("body").append("<div id='sound'></div>"),$.support.msie&&"8.0"==$.support.version?$("#sound").html('<embed src="/sound/notice.mp3"/>'):$("#sound").html('<audio autoplay="autoplay"><source src="/sound/notice.mp3" type="audio/mp3"/></audio>'),1!=e.is_tts){var i="/sound/"+o+".mp3";setTimeout((function(){if($.support.msie&&"8.0"==$.support.version)$("#sound").html('<embed src="'+i+'"/>');else{var o="__notice__"+(new Date).getTime();$("#sound").html('<audio id="'+o+'" autoplay="autoplay"><source src="'+i+'" type="audio/mp3"/></audio>'),--t>0&&$("#"+o).on("ended",(function(){setTimeout((function(){playSound(e,t)}),s)}))}}),3e3)}else setTimeout((function(){var t=new window.SpeechSynthesisUtterance(e.content);window.speechSynthesis.speak(t)}),3e3)}var szy_websocket_log_enable=!0,szy_websocket_connection_interval=5e3;function szy_websocket(e){var t,o={object:{},log_enable:!1,interval_id:null,log:function(e){(this.log_enable||szy_websocket_log_enable)&&console.info(e)},heartbeat_interval:55e3,onopen:function(e){var t=JSON.stringify(this.object);if(this.send(t),this.log("已经与服务器建立了连接，当前连接状态："+this.readyState),this.log(this.object),1==this.readyState){var o=this,n=function(){if("live_login_set"==o.object.type)var e=$.extend({},o.object,{type:"live_ping"});else e=$.extend({},o.object,{type:"ping"});o.send(JSON.stringify(e)),console.info("发送ping给服务器...")};this.interval_id=setInterval(n,this.heartbeat_interval),n()}},onmessage:function(e){this.log("接收到服务器发送的数据："),this.log(e)},onclose:function(t){null!=this.interval_id&&(clearInterval(this.interval_id),this.interval_id=null),this.log("已经与服务器断开连接，当前连接状态："+this.readyState),szy_websocket_connection_interval>0&&(this.log(szy_websocket_connection_interval/1e3+"秒后尝试重新连接..."),setTimeout((function(){szy_websocket(e)}),szy_websocket_connection_interval))},onerror:function(e){this.log("WebSocket异常："),this.log(e),this.close()}};e=$.extend(!0,o,e);try{return(t=new WebSocket(e.object.url)).object=e.object,t.log=e.log,t.interval_id=e.interval_id,t.heartbeat_interval=e.heartbeat_interval,t.onopen=e.onopen,t.onmessage=e.onmessage,t.onclose=e.onclose,t.onerror=e.onerror,t}catch(e){console.error(e)}}function WS_AddUser(e){return szy_websocket({object:e,onmessage:function(t){var o=JSON.parse(t.data);if(this.log("接收到服务器发送的数据："),this.log(o),"pong"!=o.type){var n=o;o.message&&(n=o.message),playSound(n),"function"==typeof open_message_box&&open_message_box(n),"function"==typeof auto_print&&1==n.is_auto_print&&n.order_id>0&&auto_print(n.order_id)}e.user_id&&0===e.user_id.indexOf("user_")&&("new_order_remind"==o.type&&"function"==typeof newOrderRemind&&newOrderRemind(n),"add_point"==o.type&&"function"==typeof addPoint&&addPoint(n),"qrcode_login"==o.type&&"function"==typeof qrcode_login&&qrcode_login(n))}})}function WS_AddSys(e){return szy_websocket({object:e,onmessage:function(e){var t=JSON.parse(e.data);if(this.log("接收到服务器发送的数据："),this.log(t),"pong"!=t.type){var o=t;t.message&&(o=t.message),playSound(o),$.isFunction(open_message_box)&&open_message_box(o)}}})}function WS_AddOrder(e){return szy_websocket({object:e,onmessage:function(e){var t=JSON.parse(e.data);this.log("接收到服务器发送的数据："),this.log(t),newOrderRemind(t.message)}})}function WS_QRCodeLogin(e){return szy_websocket({object:e,onmessage:function(e){var t=JSON.parse(e.data);this.log("接收到服务器发送的数据："),this.log(t),qrcode_login(t.message)}})}function WS_AddPoint(e){return szy_websocket({object:e,onmessage:function(e){var t=JSON.parse(e.data);this.log("接收到服务器发送的数据："),this.log(t),addPoint(t.message)}})}
